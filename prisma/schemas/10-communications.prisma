// ============================================================
// COMMUNICATIONS MODULE
// ============================================================
// Migrations: 020_multi_channel_communication.sql
// Purpose: Email, SMS, Chat, Message Templates, Communication Channels
// Tables: 13

model CommunicationChannel {
  id                String   @id @db.Char(36)
  tenantId          String   @db.VarChar(36) @map("tenant_id")
  channelName       String   @db.VarChar(100) @map("channel_name")
  channelType       String   @db.VarChar(50) @map("channel_type")
  description       String?  @db.Text
  isActive          Boolean  @default(true) @map("is_active")
  configData        Json?    @map("config_data")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations

  @@unique([tenantId, channelName])
  @@index([tenantId])
  @@map("communication_channel")
}

model MessageTemplate {
  id                String   @id @db.Char(36)
  tenantId          String   @db.VarChar(36) @map("tenant_id")
  templateName      String   @db.VarChar(255) @map("template_name")
  templateType      String   @db.VarChar(50) @map("template_type")
  channelId         String?  @db.VarChar(36) @map("channel_id")
  subject           String?  @db.VarChar(255)
  body              String?  @db.LongText
  variables         String?  @db.Text
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations

  @@index([tenantId])
  @@map("message_template")
}

model CommunicationSession {
  id                String   @id @db.Char(36)
  tenantId          String   @db.VarChar(36) @map("tenant_id")
  sessionId         String   @unique @db.VarChar(100) @map("session_id")
  initiatorId       String   @db.VarChar(36) @map("initiator_id")
  participantIds    String?  @db.Text @map("participant_ids")
  channelType       String   @db.VarChar(50) @map("channel_type")
  subject           String?  @db.VarChar(255)
  status            String   @default("active") @db.VarChar(50)
  startTime         DateTime @map("start_time")
  endTime           DateTime? @map("end_time")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  messages          CommunicationMessage[]

  @@index([tenantId])
  @@index([sessionId])
  @@map("communication_session")
}

model CommunicationMessage {
  id                String   @id @db.Char(36)
  tenantId          String   @db.VarChar(36) @map("tenant_id")
  sessionId         String   @db.VarChar(36) @map("session_id")
  senderId          String   @db.VarChar(36) @map("sender_id")
  recipientIds      String?  @db.Text @map("recipient_ids")
  messageType       String   @db.VarChar(50) @map("message_type")
  subject           String?  @db.VarChar(255)
  body              String?  @db.LongText
  attachments       Json?    @map("attachments")
  deliveryStatus    String   @default("pending") @db.VarChar(50) @map("delivery_status")
  readAt            DateTime? @map("read_at")
  failureReason     String?  @db.Text @map("failure_reason")
  sentAt            DateTime @default(now()) @map("sent_at")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  session           CommunicationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([sessionId])
  @@index([senderId])
  @@map("communication_message")
}

model EmailConfiguration {
  id                String   @id @db.Char(36)
  tenantId          String   @db.VarChar(36) @map("tenant_id")
  smtpServer        String   @db.VarChar(255) @map("smtp_server")
  smtpPort          Int      @map("smtp_port")
  fromEmail         String   @db.VarChar(255) @map("from_email")
  fromName          String?  @db.VarChar(255) @map("from_name")
  username          String?  @db.VarChar(255)
  password          String?  @db.VarChar(500)
  useSSL            Boolean  @default(true) @map("use_ssl")
  isActive          Boolean  @default(false) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations

  @@index([tenantId])
  @@map("email_configuration")
}

model SMSConfiguration {
  id                String   @id @db.Char(36)
  tenantId          String   @db.VarChar(36) @map("tenant_id")
  provider          String   @db.VarChar(100)
  apiKey            String   @db.VarChar(500) @map("api_key")
  senderID          String   @db.VarChar(50) @map("sender_id")
  accountBalance    Decimal? @db.Decimal(15, 2) @map("account_balance")
  isActive          Boolean  @default(false) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations

  @@index([tenantId])
  @@map("sms_configuration")
}

model WebhookEndpoint {
  id                String   @id @db.Char(36)
  tenantId          String   @db.VarChar(36) @map("tenant_id")
  endpointUrl       String   @db.VarChar(500) @map("endpoint_url")
  eventType         String   @db.VarChar(100) @map("event_type")
  isActive          Boolean  @default(true) @map("is_active")
  retryCount        Int      @default(3) @map("retry_count")
  timeout           Int      @default(30)
  lastTriggeredAt   DateTime? @map("last_triggered_at")
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations

  @@index([tenantId])
  @@map("webhook_endpoint")
}

model WebhookLog {
  id                String   @id @db.Char(36)
  tenantId          String   @db.VarChar(36) @map("tenant_id")
  webhookId         String   @db.VarChar(36) @map("webhook_id")
  eventType         String   @db.VarChar(100) @map("event_type")
  payload           Json?    @map("payload")
  statusCode        Int?     @map("status_code")
  response          String?  @db.LongText
  attemptNumber     Int      @map("attempt_number")
  nextRetryAt       DateTime? @map("next_retry_at")
  triggeredAt       DateTime @default(now()) @map("triggered_at")

  // Relations

  @@index([tenantId])
  @@index([webhookId])
  @@map("webhook_log")
}

model NotificationPreference {
  id                String   @id @db.Char(36)
  tenantId          String   @db.VarChar(36) @map("tenant_id")
  userId            String   @db.Char(36) @map("user_id")
  notificationType  String   @db.VarChar(100) @map("notification_type")
  channelType       String   @db.VarChar(50) @map("channel_type")
  isEnabled         Boolean  @default(true) @map("is_enabled")
  frequency         String?  @db.VarChar(50)
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations

  @@unique([tenantId, userId, notificationType, channelType])
  @@index([tenantId])
  @@map("notification_preference")
}

model CommunicationLog {
  id                String   @id @db.Char(36)
  tenantId          String   @db.VarChar(36) @map("tenant_id")
  communicationType String   @db.VarChar(50) @map("communication_type")
  fromId            String   @db.VarChar(36) @map("from_id")
  toId              String   @db.VarChar(36) @map("to_id")
  subject           String?  @db.VarChar(255)
  status            String   @db.VarChar(50)
  sentAt            DateTime @default(now()) @map("sent_at")
  deliveredAt       DateTime? @map("delivered_at")
  readAt            DateTime? @map("read_at")

  // Relations

  @@index([tenantId])
  @@index([fromId, toId])
  @@map("communication_log")
}
